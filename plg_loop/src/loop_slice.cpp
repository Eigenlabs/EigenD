
/*
 Copyright 2009 Eigenlabs Ltd.  http://www.eigenlabs.com

 This file is part of EigenD.

 EigenD is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.

 EigenD is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with EigenD.  If not, see <http://www.gnu.org/licenses/>.
*/

#include <picross/pic_log.h>
#include <picross/pic_float.h>
#include "loop_slice.h"
#include "loop_mod.h"
#include "loop_mod.h"
#include <cmath>

/*
   Equal power crossfade curve,
   actually (1-cos(x))/2
*/


static float fadeinslice__[FADELENGTH_SLICE] = {
0.0000000000, 0.0000023531, 0.0000094124, 0.0000211777, 0.0000376491, 0.0000588263, 0.0000847091, 0.0001152973, 
0.0001505907, 0.0001905888, 0.0002352912, 0.0002846977, 0.0003388077, 0.0003976207, 0.0004611361, 0.0005293534, 
0.0006022719, 0.0006798909, 0.0007622097, 0.0008492275, 0.0009409435, 0.0010373569, 0.0011384667, 0.0012442719, 
0.0013547717, 0.0014699648, 0.0015898504, 0.0017144271, 0.0018436939, 0.0019776495, 0.0021162928, 0.0022596223, 
0.0024076367, 0.0025603346, 0.0027177146, 0.0028797753, 0.0030465150, 0.0032179322, 0.0033940254, 0.0035747928, 
0.0037602327, 0.0039503434, 0.0041451232, 0.0043445701, 0.0045486823, 0.0047574579, 0.0049708949, 0.0051889913, 
0.0054117450, 0.0056391540, 0.0058712161, 0.0061079292, 0.0063492909, 0.0065952991, 0.0068459514, 0.0071012454, 
0.0073611788, 0.0076257491, 0.0078949538, 0.0081687904, 0.0084472563, 0.0087303489, 0.0090180654, 0.0093104033, 
0.0096073598, 0.0099089320, 0.0102151172, 0.0105259123, 0.0108413146, 0.0111613211, 0.0114859287, 0.0118151343, 
0.0121489350, 0.0124873275, 0.0128303086, 0.0131778752, 0.0135300239, 0.0138867515, 0.0142480545, 0.0146139296, 
0.0149843734, 0.0153593823, 0.0157389529, 0.0161230815, 0.0165117645, 0.0169049983, 0.0173027792, 0.0177051034, 
0.0181119671, 0.0185233666, 0.0189392979, 0.0193597571, 0.0197847403, 0.0202142435, 0.0206482626, 0.0210867935, 
0.0215298321, 0.0219773743, 0.0224294158, 0.0228859524, 0.0233469798, 0.0238124936, 0.0242824895, 0.0247569630, 
0.0252359097, 0.0257193250, 0.0262072045, 0.0266995435, 0.0271963373, 0.0276975814, 0.0282032709, 0.0287134012, 
0.0292279674, 0.0297469647, 0.0302703882, 0.0307982330, 0.0313304940, 0.0318671664, 0.0324082450, 0.0329537248, 
0.0335036006, 0.0340578672, 0.0346165195, 0.0351795521, 0.0357469598, 0.0363187372, 0.0368948789, 0.0374753796, 
0.0380602337, 0.0386494358, 0.0392429803, 0.0398408616, 0.0404430742, 0.0410496122, 0.0416604700, 0.0422756420, 
0.0428951221, 0.0435189048, 0.0441469840, 0.0447793539, 0.0454160085, 0.0460569418, 0.0467021477, 0.0473516203, 
0.0480053534, 0.0486633409, 0.0493255765, 0.0499920540, 0.0506627672, 0.0513377096, 0.0520168751, 0.0527002572, 
0.0533878494, 0.0540796453, 0.0547756384, 0.0554758221, 0.0561801898, 0.0568887349, 0.0576014508, 0.0583183307, 
0.0590393678, 0.0597645555, 0.0604938868, 0.0612273549, 0.0619649529, 0.0627066739, 0.0634525108, 0.0642024567, 
0.0649565044, 0.0657146470, 0.0664768772, 0.0672431880, 0.0680135719, 0.0687880219, 0.0695665307, 0.0703490908, 
0.0711356950, 0.0719263358, 0.0727210058, 0.0735196975, 0.0743224034, 0.0751291160, 0.0759398276, 0.0767545306, 
0.0775732174, 0.0783958802, 0.0792225113, 0.0800531029, 0.0808876472, 0.0817261364, 0.0825685625, 0.0834149176, 
0.0842651938, 0.0851193831, 0.0859774774, 0.0868394686, 0.0877053486, 0.0885751093, 0.0894487425, 0.0903262400, 
0.0912075934, 0.0920927946, 0.0929818351, 0.0938747067, 0.0947714009, 0.0956719092, 0.0965762232, 0.0974843344, 
0.0983962343, 0.0993119141, 0.1002313654, 0.1011545795, 0.1020815477, 0.1030122612, 0.1039467113, 0.1048848893, 
0.1058267862, 0.1067723932, 0.1077217014, 0.1086747019, 0.1096313857, 0.1105917438, 0.1115557672, 0.1125234467, 
0.1134947733, 0.1144697379, 0.1154483312, 0.1164305440, 0.1174163672, 0.1184057914, 0.1193988073, 0.1203954055, 
0.1213955767, 0.1223993116, 0.1234066005, 0.1244174340, 0.1254318027, 0.1264496970, 0.1274711073, 0.1284960239, 
0.1295244373, 0.1305563378, 0.1315917156, 0.1326305610, 0.1336728642, 0.1347186154, 0.1357678048, 0.1368204225, 
0.1378764585, 0.1389359030, 0.1399987460, 0.1410649775, 0.1421345874, 0.1432075656, 0.1442839021, 0.1453635868, 
0.1464466094, 0.1475329598, 0.1486226278, 0.1497156030, 0.1508118753, 0.1519114343, 0.1530142696, 0.1541203708, 
0.1552297276, 0.1563423296, 0.1574581661, 0.1585772268, 0.1596995011, 0.1608249784, 0.1619536482, 0.1630854998, 
0.1642205226, 0.1653587058, 0.1665000388, 0.1676445109, 0.1687921112, 0.1699428290, 0.1710966534, 0.1722535735, 
0.1734135785, 0.1745766575, 0.1757427995, 0.1769119935, 0.1780842286, 0.1792594936, 0.1804377776, 0.1816190694, 
0.1828033579, 0.1839906320, 0.1851808805, 0.1863740923, 0.1875702559, 0.1887693603, 0.1899713941, 0.1911763460, 
0.1923842047, 0.1935949588, 0.1948085969, 0.1960251075, 0.1972444793, 0.1984667007, 0.1996917603, 0.2009196465, 
0.2021503478, 0.2033838525, 0.2046201491, 0.2058592259, 0.2071010713, 0.2083456735, 0.2095930210, 0.2108431018, 
0.2120959043, 0.2133514167, 0.2146096271, 0.2158705237, 0.2171340946, 0.2184003280, 0.2196692119, 0.2209407344, 
0.2222148835, 0.2234916472, 0.2247710135, 0.2260529704, 0.2273375058, 0.2286246076, 0.2299142636, 0.2312064619, 
0.2325011901, 0.2337984361, 0.2350981877, 0.2364004326, 0.2377051587, 0.2390123535, 0.2403220049, 0.2416341005, 
0.2429486279, 0.2442655748, 0.2455849287, 0.2469066773, 0.2482308081, 0.2495573087, 0.2508861665, 0.2522173691, 
0.2535509039, 0.2548867584, 0.2562249199, 0.2575653760, 0.2589081140, 0.2602531212, 0.2616003850, 0.2629498927, 
0.2643016316, 0.2656555890, 0.2670117521, 0.2683701082, 0.2697306445, 0.2710933482, 0.2724582064, 0.2738252064, 
0.2751943352, 0.2765655799, 0.2779389277, 0.2793143656, 0.2806918807, 0.2820714600, 0.2834530906, 0.2848367593, 
0.2862224533, 0.2876101594, 0.2889998646, 0.2903915558, 0.2917852200, 0.2931808439, 0.2945784145, 0.2959779186, 
0.2973793430, 0.2987826746, 0.3001879001, 0.3015950063, 0.3030039800, 0.3044148078, 0.3058274767, 0.3072419731, 
0.3086582838, 0.3100763955, 0.3114962949, 0.3129179685, 0.3143414030, 0.3157665850, 0.3171935011, 0.3186221378, 
0.3200524817, 0.3214845194, 0.3229182373, 0.3243536220, 0.3257906599, 0.3272293375, 0.3286696413, 0.3301115578, 
0.3315550733, 0.3330001743, 0.3344468471, 0.3358950782, 0.3373448539, 0.3387961606, 0.3402489846, 0.3417033122, 
0.3431591298, 0.3446164236, 0.3460751800, 0.3475353851, 0.3489970253, 0.3504600868, 0.3519245559, 0.3533904187, 
0.3548576614, 0.3563262702, 0.3577962314, 0.3592675310, 0.3607401553, 0.3622140903, 0.3636893223, 0.3651658372, 
0.3666436213, 0.3681226605, 0.3696029410, 0.3710844489, 0.3725671702, 0.3740510909, 0.3755361971, 0.3770224748, 
0.3785099100, 0.3799984888, 0.3814881970, 0.3829790207, 0.3844709459, 0.3859639584, 0.3874580443, 0.3889531895, 
0.3904493799, 0.3919466015, 0.3934448400, 0.3949440816, 0.3964443119, 0.3979455170, 0.3994476826, 0.4009507946, 
0.4024548390, 0.4039598015, 0.4054656679, 0.4069724242, 0.4084800560, 0.4099885493, 0.4114978898, 0.4130080633, 
0.4145190556, 0.4160308525, 0.4175434398, 0.4190568031, 0.4205709283, 0.4220858012, 0.4236014074, 0.4251177327, 
0.4266347628, 0.4281524834, 0.4296708803, 0.4311899392, 0.4327096457, 0.4342299856, 0.4357509446, 0.4372725083, 
0.4387946624, 0.4403173926, 0.4418406845, 0.4433645239, 0.4448888964, 0.4464137875, 0.4479391831, 0.4494650686, 
0.4509914298, 0.4525182523, 0.4540455218, 0.4555732237, 0.4571013438, 0.4586298677, 0.4601587810, 0.4616880693, 
0.4632177182, 0.4647477133, 0.4662780402, 0.4678086845, 0.4693396318, 0.4708708677, 0.4724023778, 0.4739341477, 
0.4754661628, 0.4769984089, 0.4785308715, 0.4800635362, 0.4815963885, 0.4831294141, 0.4846625984, 0.4861959271, 
0.4877293857, 0.4892629599, 0.4907966350, 0.4923303969, 0.4938642309, 0.4953981226, 0.4969320577, 0.4984660216, 
0.5000000000, 0.5015339784, 0.5030679423, 0.5046018774, 0.5061357691, 0.5076696031, 0.5092033650, 0.5107370401, 
0.5122706143, 0.5138040729, 0.5153374016, 0.5168705859, 0.5184036115, 0.5199364638, 0.5214691285, 0.5230015911, 
0.5245338372, 0.5260658523, 0.5275976222, 0.5291291323, 0.5306603682, 0.5321913155, 0.5337219598, 0.5352522867, 
0.5367822818, 0.5383119307, 0.5398412190, 0.5413701323, 0.5428986562, 0.5444267763, 0.5459544782, 0.5474817477, 
0.5490085702, 0.5505349314, 0.5520608169, 0.5535862125, 0.5551111036, 0.5566354761, 0.5581593155, 0.5596826074, 
0.5612053376, 0.5627274917, 0.5642490554, 0.5657700144, 0.5672903543, 0.5688100608, 0.5703291197, 0.5718475166, 
0.5733652372, 0.5748822673, 0.5763985926, 0.5779141988, 0.5794290717, 0.5809431969, 0.5824565602, 0.5839691475, 
0.5854809444, 0.5869919367, 0.5885021102, 0.5900114507, 0.5915199440, 0.5930275758, 0.5945343321, 0.5960401985, 
0.5975451610, 0.5990492054, 0.6005523174, 0.6020544830, 0.6035556881, 0.6050559184, 0.6065551600, 0.6080533985, 
0.6095506201, 0.6110468105, 0.6125419557, 0.6140360416, 0.6155290541, 0.6170209793, 0.6185118030, 0.6200015112, 
0.6214900900, 0.6229775252, 0.6244638029, 0.6259489091, 0.6274328298, 0.6289155511, 0.6303970590, 0.6318773395, 
0.6333563787, 0.6348341628, 0.6363106777, 0.6377859097, 0.6392598447, 0.6407324690, 0.6422037686, 0.6436737298, 
0.6451423386, 0.6466095813, 0.6480754441, 0.6495399132, 0.6510029747, 0.6524646149, 0.6539248200, 0.6553835764, 
0.6568408702, 0.6582966878, 0.6597510154, 0.6612038394, 0.6626551461, 0.6641049218, 0.6655531529, 0.6669998257, 
0.6684449267, 0.6698884422, 0.6713303587, 0.6727706625, 0.6742093401, 0.6756463780, 0.6770817627, 0.6785154806, 
0.6799475183, 0.6813778622, 0.6828064989, 0.6842334150, 0.6856585970, 0.6870820315, 0.6885037051, 0.6899236045, 
0.6913417162, 0.6927580269, 0.6941725233, 0.6955851922, 0.6969960200, 0.6984049937, 0.6998120999, 0.7012173254, 
0.7026206570, 0.7040220814, 0.7054215855, 0.7068191561, 0.7082147800, 0.7096084442, 0.7110001354, 0.7123898406, 
0.7137775467, 0.7151632407, 0.7165469094, 0.7179285400, 0.7193081193, 0.7206856344, 0.7220610723, 0.7234344201, 
0.7248056648, 0.7261747936, 0.7275417936, 0.7289066518, 0.7302693555, 0.7316298918, 0.7329882479, 0.7343444110, 
0.7356983684, 0.7370501073, 0.7383996150, 0.7397468788, 0.7410918860, 0.7424346240, 0.7437750801, 0.7451132416, 
0.7464490961, 0.7477826309, 0.7491138335, 0.7504426913, 0.7517691919, 0.7530933227, 0.7544150713, 0.7557344252, 
0.7570513721, 0.7583658995, 0.7596779951, 0.7609876465, 0.7622948413, 0.7635995674, 0.7649018123, 0.7662015639, 
0.7674988099, 0.7687935381, 0.7700857364, 0.7713753924, 0.7726624942, 0.7739470296, 0.7752289865, 0.7765083528, 
0.7777851165, 0.7790592656, 0.7803307881, 0.7815996720, 0.7828659054, 0.7841294763, 0.7853903729, 0.7866485833, 
0.7879040957, 0.7891568982, 0.7904069790, 0.7916543265, 0.7928989287, 0.7941407741, 0.7953798509, 0.7966161475, 
0.7978496522, 0.7990803535, 0.8003082397, 0.8015332993, 0.8027555207, 0.8039748925, 0.8051914031, 0.8064050412, 
0.8076157953, 0.8088236540, 0.8100286059, 0.8112306397, 0.8124297441, 0.8136259077, 0.8148191195, 0.8160093680, 
0.8171966421, 0.8183809306, 0.8195622224, 0.8207405064, 0.8219157714, 0.8230880065, 0.8242572005, 0.8254233425, 
0.8265864215, 0.8277464265, 0.8289033466, 0.8300571710, 0.8312078888, 0.8323554891, 0.8334999612, 0.8346412942, 
0.8357794774, 0.8369145002, 0.8380463518, 0.8391750216, 0.8403004989, 0.8414227732, 0.8425418339, 0.8436576704, 
0.8447702724, 0.8458796292, 0.8469857304, 0.8480885657, 0.8491881247, 0.8502843970, 0.8513773722, 0.8524670402, 
0.8535533906, 0.8546364132, 0.8557160979, 0.8567924344, 0.8578654126, 0.8589350225, 0.8600012540, 0.8610640970, 
0.8621235415, 0.8631795775, 0.8642321952, 0.8652813846, 0.8663271358, 0.8673694390, 0.8684082844, 0.8694436622, 
0.8704755627, 0.8715039761, 0.8725288927, 0.8735503030, 0.8745681973, 0.8755825660, 0.8765933995, 0.8776006884, 
0.8786044233, 0.8796045945, 0.8806011927, 0.8815942086, 0.8825836328, 0.8835694560, 0.8845516688, 0.8855302621, 
0.8865052267, 0.8874765533, 0.8884442328, 0.8894082562, 0.8903686143, 0.8913252981, 0.8922782986, 0.8932276068, 
0.8941732138, 0.8951151107, 0.8960532887, 0.8969877388, 0.8979184523, 0.8988454205, 0.8997686346, 0.9006880859, 
0.9016037657, 0.9025156656, 0.9034237768, 0.9043280908, 0.9052285991, 0.9061252933, 0.9070181649, 0.9079072054, 
0.9087924066, 0.9096737600, 0.9105512575, 0.9114248907, 0.9122946514, 0.9131605314, 0.9140225226, 0.9148806169, 
0.9157348062, 0.9165850824, 0.9174314375, 0.9182738636, 0.9191123528, 0.9199468971, 0.9207774887, 0.9216041198, 
0.9224267826, 0.9232454694, 0.9240601724, 0.9248708840, 0.9256775966, 0.9264803025, 0.9272789942, 0.9280736642, 
0.9288643050, 0.9296509092, 0.9304334693, 0.9312119781, 0.9319864281, 0.9327568120, 0.9335231228, 0.9342853530, 
0.9350434956, 0.9357975433, 0.9365474892, 0.9372933261, 0.9380350471, 0.9387726451, 0.9395061132, 0.9402354445, 
0.9409606322, 0.9416816693, 0.9423985492, 0.9431112651, 0.9438198102, 0.9445241779, 0.9452243616, 0.9459203547, 
0.9466121506, 0.9472997428, 0.9479831249, 0.9486622904, 0.9493372328, 0.9500079460, 0.9506744235, 0.9513366591, 
0.9519946466, 0.9526483797, 0.9532978523, 0.9539430582, 0.9545839915, 0.9552206461, 0.9558530160, 0.9564810952, 
0.9571048779, 0.9577243580, 0.9583395300, 0.9589503878, 0.9595569258, 0.9601591384, 0.9607570197, 0.9613505642, 
0.9619397663, 0.9625246204, 0.9631051211, 0.9636812628, 0.9642530402, 0.9648204479, 0.9653834805, 0.9659421328, 
0.9664963994, 0.9670462752, 0.9675917550, 0.9681328336, 0.9686695060, 0.9692017670, 0.9697296118, 0.9702530353, 
0.9707720326, 0.9712865988, 0.9717967291, 0.9723024186, 0.9728036627, 0.9733004565, 0.9737927955, 0.9742806750, 
0.9747640903, 0.9752430370, 0.9757175105, 0.9761875064, 0.9766530202, 0.9771140476, 0.9775705842, 0.9780226257, 
0.9784701679, 0.9789132065, 0.9793517374, 0.9797857565, 0.9802152597, 0.9806402429, 0.9810607021, 0.9814766334, 
0.9818880329, 0.9822948966, 0.9826972208, 0.9830950017, 0.9834882355, 0.9838769185, 0.9842610471, 0.9846406177, 
0.9850156266, 0.9853860704, 0.9857519455, 0.9861132485, 0.9864699761, 0.9868221248, 0.9871696914, 0.9875126725, 
0.9878510650, 0.9881848657, 0.9885140713, 0.9888386789, 0.9891586854, 0.9894740877, 0.9897848828, 0.9900910680, 
0.9903926402, 0.9906895967, 0.9909819346, 0.9912696511, 0.9915527437, 0.9918312096, 0.9921050462, 0.9923742509, 
0.9926388212, 0.9928987546, 0.9931540486, 0.9934047009, 0.9936507091, 0.9938920708, 0.9941287839, 0.9943608460, 
0.9945882550, 0.9948110087, 0.9950291051, 0.9952425421, 0.9954513177, 0.9956554299, 0.9958548768, 0.9960496566, 
0.9962397673, 0.9964252072, 0.9966059746, 0.9967820678, 0.9969534850, 0.9971202247, 0.9972822854, 0.9974396654, 
0.9975923633, 0.9977403777, 0.9978837072, 0.9980223505, 0.9981563061, 0.9982855729, 0.9984101496, 0.9985300352, 
0.9986452283, 0.9987557281, 0.9988615333, 0.9989626431, 0.9990590565, 0.9991507725, 0.9992377903, 0.9993201091, 
0.9993977281, 0.9994706466, 0.9995388639, 0.9996023793, 0.9996611923, 0.9997153023, 0.9997647088, 0.9998094112, 
0.9998494093, 0.9998847027, 0.9999152909, 0.9999411737, 0.9999623509, 0.9999788223, 0.9999905876, 0.9999976469, 
};

static float fadeingrain__[FADELENGTH_GRAIN] = {
0.0000000000, 0.0001529714, 0.0006117919, 0.0013761808, 0.0024456704, 0.0038196063, 0.0054971478, 0.0074772683, 
0.0097587564, 0.0123402160, 0.0152200676, 0.0183965490, 0.0218677165, 0.0256314462, 0.0296854352, 0.0340272028, 
0.0386540925, 0.0435632730, 0.0487517405, 0.0542163202, 0.0599536686, 0.0659602749, 0.0722324638, 0.0787663975, 
0.0855580779, 0.0926033493, 0.0998979008, 0.1074372689, 0.1152168405, 0.1232318554, 0.1314774092, 0.1399484566, 
0.1486398144, 0.1575461643, 0.1666620568, 0.1759819139, 0.1855000331, 0.1952105901, 0.2051076434, 0.2151851371, 
0.2254369048, 0.2358566737, 0.2464380681, 0.2571746133, 0.2680597399, 0.2790867873, 0.2902490084, 0.3015395730, 
0.3129515727, 0.3244780246, 0.3361118759, 0.3478460079, 0.3596732407, 0.3715863375, 0.3835780087, 0.3956409168, 
0.4077676808, 0.4199508804, 0.4321830608, 0.4444567375, 0.4567644003, 0.4690985183, 0.4814515445, 0.4938159202, 
0.5061840798, 0.5185484555, 0.5309014817, 0.5432355997, 0.5555432625, 0.5678169392, 0.5800491196, 0.5922323192, 
0.6043590832, 0.6164219913, 0.6284136625, 0.6403267593, 0.6521539921, 0.6638881241, 0.6755219754, 0.6870484273, 
0.6984604270, 0.7097509916, 0.7209132127, 0.7319402601, 0.7428253867, 0.7535619319, 0.7641433263, 0.7745630952, 
0.7848148629, 0.7948923566, 0.8047894099, 0.8144999669, 0.8240180861, 0.8333379432, 0.8424538357, 0.8513601856, 
0.8600515434, 0.8685225908, 0.8767681446, 0.8847831595, 0.8925627311, 0.9001020992, 0.9073966507, 0.9144419221, 
0.9212336025, 0.9277675362, 0.9340397251, 0.9400463314, 0.9457836798, 0.9512482595, 0.9564367270, 0.9613459075, 
0.9659727972, 0.9703145648, 0.9743685538, 0.9781322835, 0.9816034510, 0.9847799324, 0.9876597840, 0.9902412436, 
0.9925227317, 0.9945028522, 0.9961803937, 0.9975543296, 0.9986238192, 0.9993882081, 0.9998470286, 1.0000000000, 
};

static float fadeoutslice__[FADELENGTH_SLICE] = {
1.0000000000, 0.9999976469, 0.9999905876, 0.9999788223, 0.9999623509, 0.9999411737, 0.9999152909, 0.9998847027, 
0.9998494093, 0.9998094112, 0.9997647088, 0.9997153023, 0.9996611923, 0.9996023793, 0.9995388639, 0.9994706466, 
0.9993977281, 0.9993201091, 0.9992377903, 0.9991507725, 0.9990590565, 0.9989626431, 0.9988615333, 0.9987557281, 
0.9986452283, 0.9985300352, 0.9984101496, 0.9982855729, 0.9981563061, 0.9980223505, 0.9978837072, 0.9977403777, 
0.9975923633, 0.9974396654, 0.9972822854, 0.9971202247, 0.9969534850, 0.9967820678, 0.9966059746, 0.9964252072, 
0.9962397673, 0.9960496566, 0.9958548768, 0.9956554299, 0.9954513177, 0.9952425421, 0.9950291051, 0.9948110087, 
0.9945882550, 0.9943608460, 0.9941287839, 0.9938920708, 0.9936507091, 0.9934047009, 0.9931540486, 0.9928987546, 
0.9926388212, 0.9923742509, 0.9921050462, 0.9918312096, 0.9915527437, 0.9912696511, 0.9909819346, 0.9906895967, 
0.9903926402, 0.9900910680, 0.9897848828, 0.9894740877, 0.9891586854, 0.9888386789, 0.9885140713, 0.9881848657, 
0.9878510650, 0.9875126725, 0.9871696914, 0.9868221248, 0.9864699761, 0.9861132485, 0.9857519455, 0.9853860704, 
0.9850156266, 0.9846406177, 0.9842610471, 0.9838769185, 0.9834882355, 0.9830950017, 0.9826972208, 0.9822948966, 
0.9818880329, 0.9814766334, 0.9810607021, 0.9806402429, 0.9802152597, 0.9797857565, 0.9793517374, 0.9789132065, 
0.9784701679, 0.9780226257, 0.9775705842, 0.9771140476, 0.9766530202, 0.9761875064, 0.9757175105, 0.9752430370, 
0.9747640903, 0.9742806750, 0.9737927955, 0.9733004565, 0.9728036627, 0.9723024186, 0.9717967291, 0.9712865988, 
0.9707720326, 0.9702530353, 0.9697296118, 0.9692017670, 0.9686695060, 0.9681328336, 0.9675917550, 0.9670462752, 
0.9664963994, 0.9659421328, 0.9653834805, 0.9648204479, 0.9642530402, 0.9636812628, 0.9631051211, 0.9625246204, 
0.9619397663, 0.9613505642, 0.9607570197, 0.9601591384, 0.9595569258, 0.9589503878, 0.9583395300, 0.9577243580, 
0.9571048779, 0.9564810952, 0.9558530160, 0.9552206461, 0.9545839915, 0.9539430582, 0.9532978523, 0.9526483797, 
0.9519946466, 0.9513366591, 0.9506744235, 0.9500079460, 0.9493372328, 0.9486622904, 0.9479831249, 0.9472997428, 
0.9466121506, 0.9459203547, 0.9452243616, 0.9445241779, 0.9438198102, 0.9431112651, 0.9423985492, 0.9416816693, 
0.9409606322, 0.9402354445, 0.9395061132, 0.9387726451, 0.9380350471, 0.9372933261, 0.9365474892, 0.9357975433, 
0.9350434956, 0.9342853530, 0.9335231228, 0.9327568120, 0.9319864281, 0.9312119781, 0.9304334693, 0.9296509092, 
0.9288643050, 0.9280736642, 0.9272789942, 0.9264803025, 0.9256775966, 0.9248708840, 0.9240601724, 0.9232454694, 
0.9224267826, 0.9216041198, 0.9207774887, 0.9199468971, 0.9191123528, 0.9182738636, 0.9174314375, 0.9165850824, 
0.9157348062, 0.9148806169, 0.9140225226, 0.9131605314, 0.9122946514, 0.9114248907, 0.9105512575, 0.9096737600, 
0.9087924066, 0.9079072054, 0.9070181649, 0.9061252933, 0.9052285991, 0.9043280908, 0.9034237768, 0.9025156656, 
0.9016037657, 0.9006880859, 0.8997686346, 0.8988454205, 0.8979184523, 0.8969877388, 0.8960532887, 0.8951151107, 
0.8941732138, 0.8932276068, 0.8922782986, 0.8913252981, 0.8903686143, 0.8894082562, 0.8884442328, 0.8874765533, 
0.8865052267, 0.8855302621, 0.8845516688, 0.8835694560, 0.8825836328, 0.8815942086, 0.8806011927, 0.8796045945, 
0.8786044233, 0.8776006884, 0.8765933995, 0.8755825660, 0.8745681973, 0.8735503030, 0.8725288927, 0.8715039761, 
0.8704755627, 0.8694436622, 0.8684082844, 0.8673694390, 0.8663271358, 0.8652813846, 0.8642321952, 0.8631795775, 
0.8621235415, 0.8610640970, 0.8600012540, 0.8589350225, 0.8578654126, 0.8567924344, 0.8557160979, 0.8546364132, 
0.8535533906, 0.8524670402, 0.8513773722, 0.8502843970, 0.8491881247, 0.8480885657, 0.8469857304, 0.8458796292, 
0.8447702724, 0.8436576704, 0.8425418339, 0.8414227732, 0.8403004989, 0.8391750216, 0.8380463518, 0.8369145002, 
0.8357794774, 0.8346412942, 0.8334999612, 0.8323554891, 0.8312078888, 0.8300571710, 0.8289033466, 0.8277464265, 
0.8265864215, 0.8254233425, 0.8242572005, 0.8230880065, 0.8219157714, 0.8207405064, 0.8195622224, 0.8183809306, 
0.8171966421, 0.8160093680, 0.8148191195, 0.8136259077, 0.8124297441, 0.8112306397, 0.8100286059, 0.8088236540, 
0.8076157953, 0.8064050412, 0.8051914031, 0.8039748925, 0.8027555207, 0.8015332993, 0.8003082397, 0.7990803535, 
0.7978496522, 0.7966161475, 0.7953798509, 0.7941407741, 0.7928989287, 0.7916543265, 0.7904069790, 0.7891568982, 
0.7879040957, 0.7866485833, 0.7853903729, 0.7841294763, 0.7828659054, 0.7815996720, 0.7803307881, 0.7790592656, 
0.7777851165, 0.7765083528, 0.7752289865, 0.7739470296, 0.7726624942, 0.7713753924, 0.7700857364, 0.7687935381, 
0.7674988099, 0.7662015639, 0.7649018123, 0.7635995674, 0.7622948413, 0.7609876465, 0.7596779951, 0.7583658995, 
0.7570513721, 0.7557344252, 0.7544150713, 0.7530933227, 0.7517691919, 0.7504426913, 0.7491138335, 0.7477826309, 
0.7464490961, 0.7451132416, 0.7437750801, 0.7424346240, 0.7410918860, 0.7397468788, 0.7383996150, 0.7370501073, 
0.7356983684, 0.7343444110, 0.7329882479, 0.7316298918, 0.7302693555, 0.7289066518, 0.7275417936, 0.7261747936, 
0.7248056648, 0.7234344201, 0.7220610723, 0.7206856344, 0.7193081193, 0.7179285400, 0.7165469094, 0.7151632407, 
0.7137775467, 0.7123898406, 0.7110001354, 0.7096084442, 0.7082147800, 0.7068191561, 0.7054215855, 0.7040220814, 
0.7026206570, 0.7012173254, 0.6998120999, 0.6984049937, 0.6969960200, 0.6955851922, 0.6941725233, 0.6927580269, 
0.6913417162, 0.6899236045, 0.6885037051, 0.6870820315, 0.6856585970, 0.6842334150, 0.6828064989, 0.6813778622, 
0.6799475183, 0.6785154806, 0.6770817627, 0.6756463780, 0.6742093401, 0.6727706625, 0.6713303587, 0.6698884422, 
0.6684449267, 0.6669998257, 0.6655531529, 0.6641049218, 0.6626551461, 0.6612038394, 0.6597510154, 0.6582966878, 
0.6568408702, 0.6553835764, 0.6539248200, 0.6524646149, 0.6510029747, 0.6495399132, 0.6480754441, 0.6466095813, 
0.6451423386, 0.6436737298, 0.6422037686, 0.6407324690, 0.6392598447, 0.6377859097, 0.6363106777, 0.6348341628, 
0.6333563787, 0.6318773395, 0.6303970590, 0.6289155511, 0.6274328298, 0.6259489091, 0.6244638029, 0.6229775252, 
0.6214900900, 0.6200015112, 0.6185118030, 0.6170209793, 0.6155290541, 0.6140360416, 0.6125419557, 0.6110468105, 
0.6095506201, 0.6080533985, 0.6065551600, 0.6050559184, 0.6035556881, 0.6020544830, 0.6005523174, 0.5990492054, 
0.5975451610, 0.5960401985, 0.5945343321, 0.5930275758, 0.5915199440, 0.5900114507, 0.5885021102, 0.5869919367, 
0.5854809444, 0.5839691475, 0.5824565602, 0.5809431969, 0.5794290717, 0.5779141988, 0.5763985926, 0.5748822673, 
0.5733652372, 0.5718475166, 0.5703291197, 0.5688100608, 0.5672903543, 0.5657700144, 0.5642490554, 0.5627274917, 
0.5612053376, 0.5596826074, 0.5581593155, 0.5566354761, 0.5551111036, 0.5535862125, 0.5520608169, 0.5505349314, 
0.5490085702, 0.5474817477, 0.5459544782, 0.5444267763, 0.5428986562, 0.5413701323, 0.5398412190, 0.5383119307, 
0.5367822818, 0.5352522867, 0.5337219598, 0.5321913155, 0.5306603682, 0.5291291323, 0.5275976222, 0.5260658523, 
0.5245338372, 0.5230015911, 0.5214691285, 0.5199364638, 0.5184036115, 0.5168705859, 0.5153374016, 0.5138040729, 
0.5122706143, 0.5107370401, 0.5092033650, 0.5076696031, 0.5061357691, 0.5046018774, 0.5030679423, 0.5015339784, 
0.5000000000, 0.4984660216, 0.4969320577, 0.4953981226, 0.4938642309, 0.4923303969, 0.4907966350, 0.4892629599, 
0.4877293857, 0.4861959271, 0.4846625984, 0.4831294141, 0.4815963885, 0.4800635362, 0.4785308715, 0.4769984089, 
0.4754661628, 0.4739341477, 0.4724023778, 0.4708708677, 0.4693396318, 0.4678086845, 0.4662780402, 0.4647477133, 
0.4632177182, 0.4616880693, 0.4601587810, 0.4586298677, 0.4571013438, 0.4555732237, 0.4540455218, 0.4525182523, 
0.4509914298, 0.4494650686, 0.4479391831, 0.4464137875, 0.4448888964, 0.4433645239, 0.4418406845, 0.4403173926, 
0.4387946624, 0.4372725083, 0.4357509446, 0.4342299856, 0.4327096457, 0.4311899392, 0.4296708803, 0.4281524834, 
0.4266347628, 0.4251177327, 0.4236014074, 0.4220858012, 0.4205709283, 0.4190568031, 0.4175434398, 0.4160308525, 
0.4145190556, 0.4130080633, 0.4114978898, 0.4099885493, 0.4084800560, 0.4069724242, 0.4054656679, 0.4039598015, 
0.4024548390, 0.4009507946, 0.3994476826, 0.3979455170, 0.3964443119, 0.3949440816, 0.3934448400, 0.3919466015, 
0.3904493799, 0.3889531895, 0.3874580443, 0.3859639584, 0.3844709459, 0.3829790207, 0.3814881970, 0.3799984888, 
0.3785099100, 0.3770224748, 0.3755361971, 0.3740510909, 0.3725671702, 0.3710844489, 0.3696029410, 0.3681226605, 
0.3666436213, 0.3651658372, 0.3636893223, 0.3622140903, 0.3607401553, 0.3592675310, 0.3577962314, 0.3563262702, 
0.3548576614, 0.3533904187, 0.3519245559, 0.3504600868, 0.3489970253, 0.3475353851, 0.3460751800, 0.3446164236, 
0.3431591298, 0.3417033122, 0.3402489846, 0.3387961606, 0.3373448539, 0.3358950782, 0.3344468471, 0.3330001743, 
0.3315550733, 0.3301115578, 0.3286696413, 0.3272293375, 0.3257906599, 0.3243536220, 0.3229182373, 0.3214845194, 
0.3200524817, 0.3186221378, 0.3171935011, 0.3157665850, 0.3143414030, 0.3129179685, 0.3114962949, 0.3100763955, 
0.3086582838, 0.3072419731, 0.3058274767, 0.3044148078, 0.3030039800, 0.3015950063, 0.3001879001, 0.2987826746, 
0.2973793430, 0.2959779186, 0.2945784145, 0.2931808439, 0.2917852200, 0.2903915558, 0.2889998646, 0.2876101594, 
0.2862224533, 0.2848367593, 0.2834530906, 0.2820714600, 0.2806918807, 0.2793143656, 0.2779389277, 0.2765655799, 
0.2751943352, 0.2738252064, 0.2724582064, 0.2710933482, 0.2697306445, 0.2683701082, 0.2670117521, 0.2656555890, 
0.2643016316, 0.2629498927, 0.2616003850, 0.2602531212, 0.2589081140, 0.2575653760, 0.2562249199, 0.2548867584, 
0.2535509039, 0.2522173691, 0.2508861665, 0.2495573087, 0.2482308081, 0.2469066773, 0.2455849287, 0.2442655748, 
0.2429486279, 0.2416341005, 0.2403220049, 0.2390123535, 0.2377051587, 0.2364004326, 0.2350981877, 0.2337984361, 
0.2325011901, 0.2312064619, 0.2299142636, 0.2286246076, 0.2273375058, 0.2260529704, 0.2247710135, 0.2234916472, 
0.2222148835, 0.2209407344, 0.2196692119, 0.2184003280, 0.2171340946, 0.2158705237, 0.2146096271, 0.2133514167, 
0.2120959043, 0.2108431018, 0.2095930210, 0.2083456735, 0.2071010713, 0.2058592259, 0.2046201491, 0.2033838525, 
0.2021503478, 0.2009196465, 0.1996917603, 0.1984667007, 0.1972444793, 0.1960251075, 0.1948085969, 0.1935949588, 
0.1923842047, 0.1911763460, 0.1899713941, 0.1887693603, 0.1875702559, 0.1863740923, 0.1851808805, 0.1839906320, 
0.1828033579, 0.1816190694, 0.1804377776, 0.1792594936, 0.1780842286, 0.1769119935, 0.1757427995, 0.1745766575, 
0.1734135785, 0.1722535735, 0.1710966534, 0.1699428290, 0.1687921112, 0.1676445109, 0.1665000388, 0.1653587058, 
0.1642205226, 0.1630854998, 0.1619536482, 0.1608249784, 0.1596995011, 0.1585772268, 0.1574581661, 0.1563423296, 
0.1552297276, 0.1541203708, 0.1530142696, 0.1519114343, 0.1508118753, 0.1497156030, 0.1486226278, 0.1475329598, 
0.1464466094, 0.1453635868, 0.1442839021, 0.1432075656, 0.1421345874, 0.1410649775, 0.1399987460, 0.1389359030, 
0.1378764585, 0.1368204225, 0.1357678048, 0.1347186154, 0.1336728642, 0.1326305610, 0.1315917156, 0.1305563378, 
0.1295244373, 0.1284960239, 0.1274711073, 0.1264496970, 0.1254318027, 0.1244174340, 0.1234066005, 0.1223993116, 
0.1213955767, 0.1203954055, 0.1193988073, 0.1184057914, 0.1174163672, 0.1164305440, 0.1154483312, 0.1144697379, 
0.1134947733, 0.1125234467, 0.1115557672, 0.1105917438, 0.1096313857, 0.1086747019, 0.1077217014, 0.1067723932, 
0.1058267862, 0.1048848893, 0.1039467113, 0.1030122612, 0.1020815477, 0.1011545795, 0.1002313654, 0.0993119141, 
0.0983962343, 0.0974843344, 0.0965762232, 0.0956719092, 0.0947714009, 0.0938747067, 0.0929818351, 0.0920927946, 
0.0912075934, 0.0903262400, 0.0894487425, 0.0885751093, 0.0877053486, 0.0868394686, 0.0859774774, 0.0851193831, 
0.0842651938, 0.0834149176, 0.0825685625, 0.0817261364, 0.0808876472, 0.0800531029, 0.0792225113, 0.0783958802, 
0.0775732174, 0.0767545306, 0.0759398276, 0.0751291160, 0.0743224034, 0.0735196975, 0.0727210058, 0.0719263358, 
0.0711356950, 0.0703490908, 0.0695665307, 0.0687880219, 0.0680135719, 0.0672431880, 0.0664768772, 0.0657146470, 
0.0649565044, 0.0642024567, 0.0634525108, 0.0627066739, 0.0619649529, 0.0612273549, 0.0604938868, 0.0597645555, 
0.0590393678, 0.0583183307, 0.0576014508, 0.0568887349, 0.0561801898, 0.0554758221, 0.0547756384, 0.0540796453, 
0.0533878494, 0.0527002572, 0.0520168751, 0.0513377096, 0.0506627672, 0.0499920540, 0.0493255765, 0.0486633409, 
0.0480053534, 0.0473516203, 0.0467021477, 0.0460569418, 0.0454160085, 0.0447793539, 0.0441469840, 0.0435189048, 
0.0428951221, 0.0422756420, 0.0416604700, 0.0410496122, 0.0404430742, 0.0398408616, 0.0392429803, 0.0386494358, 
0.0380602337, 0.0374753796, 0.0368948789, 0.0363187372, 0.0357469598, 0.0351795521, 0.0346165195, 0.0340578672, 
0.0335036006, 0.0329537248, 0.0324082450, 0.0318671664, 0.0313304940, 0.0307982330, 0.0302703882, 0.0297469647, 
0.0292279674, 0.0287134012, 0.0282032709, 0.0276975814, 0.0271963373, 0.0266995435, 0.0262072045, 0.0257193250, 
0.0252359097, 0.0247569630, 0.0242824895, 0.0238124936, 0.0233469798, 0.0228859524, 0.0224294158, 0.0219773743, 
0.0215298321, 0.0210867935, 0.0206482626, 0.0202142435, 0.0197847403, 0.0193597571, 0.0189392979, 0.0185233666, 
0.0181119671, 0.0177051034, 0.0173027792, 0.0169049983, 0.0165117645, 0.0161230815, 0.0157389529, 0.0153593823, 
0.0149843734, 0.0146139296, 0.0142480545, 0.0138867515, 0.0135300239, 0.0131778752, 0.0128303086, 0.0124873275, 
0.0121489350, 0.0118151343, 0.0114859287, 0.0111613211, 0.0108413146, 0.0105259123, 0.0102151172, 0.0099089320, 
0.0096073598, 0.0093104033, 0.0090180654, 0.0087303489, 0.0084472563, 0.0081687904, 0.0078949538, 0.0076257491, 
0.0073611788, 0.0071012454, 0.0068459514, 0.0065952991, 0.0063492909, 0.0061079292, 0.0058712161, 0.0056391540, 
0.0054117450, 0.0051889913, 0.0049708949, 0.0047574579, 0.0045486823, 0.0043445701, 0.0041451232, 0.0039503434, 
0.0037602327, 0.0035747928, 0.0033940254, 0.0032179322, 0.0030465150, 0.0028797753, 0.0027177146, 0.0025603346, 
0.0024076367, 0.0022596223, 0.0021162928, 0.0019776495, 0.0018436939, 0.0017144271, 0.0015898504, 0.0014699648, 
0.0013547717, 0.0012442719, 0.0011384667, 0.0010373569, 0.0009409435, 0.0008492275, 0.0007622097, 0.0006798909, 
0.0006022719, 0.0005293534, 0.0004611361, 0.0003976207, 0.0003388077, 0.0002846977, 0.0002352912, 0.0001905888, 
0.0001505907, 0.0001152973, 0.0000847091, 0.0000588263, 0.0000376491, 0.0000211777, 0.0000094124, 0.0000023531, 
};


static float fadeoutgrain__[FADELENGTH_GRAIN] = {
1.0000000000, 0.9998470286, 0.9993882081, 0.9986238192, 0.9975543296, 0.9961803937, 0.9945028522, 0.9925227317, 
0.9902412436, 0.9876597840, 0.9847799324, 0.9816034510, 0.9781322835, 0.9743685538, 0.9703145648, 0.9659727972, 
0.9613459075, 0.9564367270, 0.9512482595, 0.9457836798, 0.9400463314, 0.9340397251, 0.9277675362, 0.9212336025, 
0.9144419221, 0.9073966507, 0.9001020992, 0.8925627311, 0.8847831595, 0.8767681446, 0.8685225908, 0.8600515434, 
0.8513601856, 0.8424538357, 0.8333379432, 0.8240180861, 0.8144999669, 0.8047894099, 0.7948923566, 0.7848148629, 
0.7745630952, 0.7641433263, 0.7535619319, 0.7428253867, 0.7319402601, 0.7209132127, 0.7097509916, 0.6984604270, 
0.6870484273, 0.6755219754, 0.6638881241, 0.6521539921, 0.6403267593, 0.6284136625, 0.6164219913, 0.6043590832, 
0.5922323192, 0.5800491196, 0.5678169392, 0.5555432625, 0.5432355997, 0.5309014817, 0.5185484555, 0.5061840798, 
0.4938159202, 0.4814515445, 0.4690985183, 0.4567644003, 0.4444567375, 0.4321830608, 0.4199508804, 0.4077676808, 
0.3956409168, 0.3835780087, 0.3715863375, 0.3596732407, 0.3478460079, 0.3361118759, 0.3244780246, 0.3129515727, 
0.3015395730, 0.2902490084, 0.2790867873, 0.2680597399, 0.2571746133, 0.2464380681, 0.2358566737, 0.2254369048, 
0.2151851371, 0.2051076434, 0.1952105901, 0.1855000331, 0.1759819139, 0.1666620568, 0.1575461643, 0.1486398144, 
0.1399484566, 0.1314774092, 0.1232318554, 0.1152168405, 0.1074372689, 0.0998979008, 0.0926033493, 0.0855580779, 
0.0787663975, 0.0722324638, 0.0659602749, 0.0599536686, 0.0542163202, 0.0487517405, 0.0435632730, 0.0386540925, 
0.0340272028, 0.0296854352, 0.0256314462, 0.0218677165, 0.0183965490, 0.0152200676, 0.0123402160, 0.0097587564, 
0.0074772683, 0.0054971478, 0.0038196063, 0.0024456704, 0.0013761808, 0.0006117919, 0.0001529714, 0.0000000000, 
};

#define DEFAULT_GRAIN_TIME 0.03f
#define MAX_GRAIN_TIME 0.05f
#define CORR_WIDTH 500
#define CORR_START 100

static float __inner(const float *a, const float *b, unsigned len, unsigned stride)
{
    float ret(0.f);
    for(unsigned i=0; i<len; ++i)
        ret += (a[i*stride]*b[i*stride]);
    return ret;
}

loop::slice_t::slice_t(const loop::loopref_t &l, unsigned long t0, unsigned long t1) : data_(0), gain_(1.0), decay_(0.9999), decay0_(1.0)
{
    beat_mod_ = l->beats();
    channels_ = l->num_channels();
    samplerate_ = l->sample_rate();

    beat_start_ = beat_mod_*((float)t0)/((float)l->samples());
    beat_end_ = beat_mod_*((float)t1)/((float)l->samples());
    beat_len_ = distance(beat_start_,beat_end_,beat_mod_);


    t0 = back(t0, FADELENGTH_SLICE, l->samples());
    frames_ = distance(t0, t1, l->samples());
    data_ = (float *)pic_thread_lck_malloc(sizeof(float)*frames_*channels_);

    if(t0 < t1)
    {
        std::copy(l->frame(t0), l->frame(t1), data_);
    }
    else
    {
        float *p = data_;
        p = std::copy(l->frame(t0), l->frame(l->samples()), p);
        std::copy(l->frame(0), l->frame(t1), p);
    }

    unsigned long gmax = (unsigned long)(MAX_GRAIN_TIME*samplerate_);
    long end_bit = frames_-CORR_WIDTH;
    float maxcor = 1.f;
    int maxind = -1;
    for(unsigned i=0; i<gmax; i++)
    {
        long bit = end_bit-(CORR_START+i);
        float cor = __inner(data_+bit*channels_,data_+end_bit*channels_,CORR_WIDTH,channels_);
        if(cor>maxcor)
        {
            maxcor = cor;
            maxind = i;
        }
    }

    gsize_ = std::min((unsigned long)(DEFAULT_GRAIN_TIME*samplerate_), t1-t0);
    if(maxind>0)
    {
        gsize_ = std::min((unsigned long)(CORR_START+maxind),t1-t0);
    }
    add_xfade();
}

loop::slice_t::~slice_t()
{
    pic_thread_lck_free(data_,sizeof(float)*frames_*channels_);
}

void loop::slice_t::add_xfade()
{
    unsigned inpos = frames_-gsize_-FADELENGTH_GRAIN;
    unsigned outpos = frames_-FADELENGTH_GRAIN;

    for(unsigned i=0; i<FADELENGTH_GRAIN; ++i)
    {
        float in = fadeingrain__[i];
        float out = fadeoutgrain__[i];

        float *op = data_ + (outpos+i)*channels_;
        float *ip = data_ + (inpos+i)*channels_;

        for(unsigned c = 0; c < channels_; ++c, ++op, ++ip)
        {
            *op = out*(*op) + in*(*ip);
        }
    }
}


static float __clip(float f)
{
    if(!pic::isnormal(f))
        return 0.f;
    return std::min(1.f,std::max(0.f,f));
}

float loop::slice_t::interpolate(unsigned c)
{
    unsigned idx = phase_.index();

    float x0 = data_[idx*channels_+c]; if(++idx>=frames_) idx-=gsize_;
    float x1 = data_[idx*channels_+c]; if(++idx>=frames_) idx-=gsize_;
    float x2 = data_[idx*channels_+c]; if(++idx>=frames_) idx-=gsize_;
    float x3 = data_[idx*channels_+c];

    return phase_.interpolate0_flt(x0,x1,x2,x3);
}

float loop::slice_t::interpolate_fade(const float *data, piw::phase_t &phase)
{
    unsigned long idx = std::min(FADELENGTH_SLICE-1,(unsigned long)phase.index());

    float x0 = data[idx]; idx = std::min(FADELENGTH_SLICE-1,idx+1);
    float x1 = data[idx]; idx = std::min(FADELENGTH_SLICE-1,idx+1);
    float x2 = data[idx]; idx = std::min(FADELENGTH_SLICE-1,idx+1);
    float x3 = data[idx];

    return phase.interpolate0_flt(x0,x1,x2,x3);
}

bool loop::slice_t::mono()
{
    return channels_==1;
}

void loop::slice_t::render(float **output, unsigned o, unsigned n, float sr, bool initial)
{
    piw::phase_t inc(samplerate_/sr);
    if(initial)
    {
        phase_ += FADELENGTH_SLICE;
    }

    if(mono())
    {
        for(unsigned i=0; i<n; ++i, ++o)
        {
            gain_ = __clip(gain_*decay0_);
            float x = gain_*interpolate(0);
            *(output[0]+o) += x;
            *(output[1]+o) += x;
            phase_.advance(inc);
            if(phase_.index()>=frames_)
            {
                decay0_ = decay_;
                phase_ -= gsize_;
            }
        }
    }
    else
    {
        for(unsigned i=0; i<n; ++i, ++o)
        {
            gain_ = __clip(gain_*decay0_);
            for(unsigned c = 0; c<channels_; ++c)
            {
                *(output[c]+o) += gain_*interpolate(c);
            }
            phase_.advance(inc);
            if(phase_.index()>=frames_)
            {
                decay0_ = decay_;
                phase_ -= gsize_;
            }
        }
    }
}

unsigned loop::slice_t::fade(float **output, unsigned o, unsigned n, float sr, const float *fdata, piw::phase_t &fphase)
{
    piw::phase_t inc(samplerate_/sr);
    piw::phase_t finc(48000.f/sr);

    if(mono())
    {
        for(unsigned i=0; i<n; ++i, ++o)
        {
            gain_ = __clip(gain_*decay0_);
            float fade = interpolate_fade(fdata,fphase);
            float x = gain_*(interpolate(0) * fade);
            *(output[0]+o) += x;
            *(output[1]+o) += x;
            phase_.advance(inc);
            if(phase_.index()>=frames_)
            {
                decay0_ = decay_;
                phase_ -= gsize_;
            }
            fphase.advance(finc);
            if(fphase.index()>=FADELENGTH_SLICE)
            {
                return i+1;
            }
        }
    }
    else
    {
        for(unsigned i=0; i<n; ++i, ++o)
        {
            gain_ = __clip(gain_*decay0_);
            float fade = interpolate_fade(fdata,fphase);
            for(unsigned c=0; c<channels_; ++c)
            {
                *(output[c]+o) += gain_*(interpolate(c) * fade);
            }
            phase_.advance(inc);
            if(phase_.index()>=frames_)
            {
                decay0_ = decay_;
                phase_ -= gsize_;
            }
            fphase.advance(finc);
            if(fphase.index()>=FADELENGTH_SLICE)
            {
                return i+1;
            }
        }
    }

    return n;
}

unsigned loop::slice_t::fadein(float **output, unsigned o, unsigned n, float sr)
{
    return fade(output,o,n,sr,fadeinslice__,fadeinphase_);
}

unsigned loop::slice_t::fadeout(float **output, unsigned o, unsigned n, float sr)
{
    return fade(output,o,n,sr,fadeoutslice__,fadeoutphase_);
}

void loop::slice_t::reset(float c)
{
    phase_ = 0;
    fadeinphase_ = 0;
    fadeoutphase_ = 0;
    decay_ = std::min(1.f,c);
    gain_ = 1.f;
    decay0_ = 1.f;
}
